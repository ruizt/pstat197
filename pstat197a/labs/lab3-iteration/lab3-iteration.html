<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Iteration strategies</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      Data Science Capstone
      </li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../img/ucsbds_hex.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../../">Data Science Capstone</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/pstat197" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://ucsbdscapstone.slack.com" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-slack"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../people.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">People</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Projects</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../projects/projects-22-23.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2022-2023 Projects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../projects/projects-21-22.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2021-2022 Projects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../projects/projects-20-21.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2020-2021 Projects</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Class materials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">PSTAT197A</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../pstat197a/about-syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course syllabus</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../pstat197a/about-materials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Materials</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">PSTAT197B-C</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../pstat197bc/about-syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course syllabus</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#loops" id="toc-loops" class="nav-link" data-scroll-target="#loops">Loops</a>
  <ul class="collapse">
  <li><a href="#simple-examples" id="toc-simple-examples" class="nav-link" data-scroll-target="#simple-examples">Simple examples</a></li>
  <li><a href="#multiple-testing-with-loops" id="toc-multiple-testing-with-loops" class="nav-link" data-scroll-target="#multiple-testing-with-loops">Multiple testing with loops</a></li>
  </ul></li>
  <li><a href="#apply-family" id="toc-apply-family" class="nav-link" data-scroll-target="#apply-family">Apply family</a>
  <ul class="collapse">
  <li><a href="#simple-examples-1" id="toc-simple-examples-1" class="nav-link" data-scroll-target="#simple-examples-1">Simple examples</a></li>
  <li><a href="#t-tests-using-apply" id="toc-t-tests-using-apply" class="nav-link" data-scroll-target="#t-tests-using-apply"><span class="math inline">\(t\)</span>-tests using apply</a></li>
  </ul></li>
  <li><a href="#tidyverse" id="toc-tidyverse" class="nav-link" data-scroll-target="#tidyverse">Tidyverse</a>
  <ul class="collapse">
  <li><a href="#nesting" id="toc-nesting" class="nav-link" data-scroll-target="#nesting">Nesting</a></li>
  <li><a href="#the-map-function" id="toc-the-map-function" class="nav-link" data-scroll-target="#the-map-function">The <code>map()</code> function</a></li>
  <li><a href="#adjusting-p-values" id="toc-adjusting-p-values" class="nav-link" data-scroll-target="#adjusting-p-values">Adjusting p-values</a></li>
  </ul></li>
  <li><a href="#checklist" id="toc-checklist" class="nav-link" data-scroll-target="#checklist">Checklist</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Iteration strategies</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>In class we discussed multiple testing in the context of an application that involved performing 1,317 <span class="math inline">\(t\)</span>-tests. Implementing these tests involves <strong><em>iteration</em></strong>: repeatedly performing the same computations.</p>
<p><strong><em>Objective.</em></strong> Here we’ll look at a few strategies for iteration in R:</p>
<ul>
<li><p>loops</p></li>
<li><p>functions in the <code>apply</code> family</p></li>
<li><p>functional programming using <code>tidyverse</code></p></li>
</ul>
<p>We’ll illustrate these strategies using the biomarker data and reproduce some of the results shown in class.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Action
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new script for lab 3 in your labs project/folder and copy-paste the code chunk below at the top of the script.</p>
</div>
</div>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-1_aad748ae5c69c9516b9bd753b5562d84">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages('infer') # execute once then comment out</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># data location</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">'https://raw.githubusercontent.com/pstat197/pstat197a/main/materials/labs/lab3-iteration/data/biomarker-clean.csv'</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># function for outlier trimming</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>trim_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  x[x <span class="sc">&gt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  x[x <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">3</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># read in and preprocess data</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>asd <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(url) <span class="sc">%&gt;%</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ados) <span class="sc">%&gt;%</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log transform</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="sc">-</span>group, log10)) <span class="sc">%&gt;%</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># center and scale</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="sc">-</span>group, <span class="sc">~</span> <span class="fu">scale</span>(.x)[, <span class="dv">1</span>])) <span class="sc">%&gt;%</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># trim outliers</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="sc">-</span>group, trim_fn))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loops" class="level2">
<h2 class="anchored" data-anchor-id="loops">Loops</h2>
<section id="simple-examples" class="level3">
<h3 class="anchored" data-anchor-id="simple-examples">Simple examples</h3>
<p>A <strong><em>loop</em></strong> is a set of instructions to be repeated a specified number of times while incrementing a flag or index value. For example:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-2_581f39f5216115e37253d0410acd2cda">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="dv">2</span><span class="sc">*</span>i)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2
[1] 4
[1] 6
[1] 8</code></pre>
</div>
</div>
<p>Here the instructions are:</p>
<ol type="1">
<li>initialize index/flag <code>i</code> at <code>i = 1</code></li>
<li>execute code within the braces <code>{...}</code></li>
<li>increment <code>i &lt;- i + 1</code></li>
<li>repeat steps 2-3 until <code>i = 5</code></li>
</ol>
<p>We could make the loop a bit more verbose:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-3_61594cbcf738916ab161dd85ae5b15b1">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>flag_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> flag_vals){</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>i</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(out)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2
[1] 4
[1] 6
[1] 8</code></pre>
</div>
</div>
<p>Now to retain the results in memory, a storage data structure must be defined and the output of each iteration assigned to some element(s) of the storage object.</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-4_a6ccbe8a75bded19a1ee9d0ba44a9fc0">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>rslt <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">4</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>){</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  rslt[i] <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>i</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>rslt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 4 6 8</code></pre>
</div>
</div>
<p>If we want to perform the same calculation for all values in a vector, we might do something like this:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-5_c4f9b0cef687d75a9709bc5d855355f7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rslt <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">4</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>input_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">27</span>, <span class="dv">3</span>, <span class="fl">12.6</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>){</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  rslt[i] <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>input_vals[i]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>rslt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 30.0 54.0  6.0 25.2</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Check your understanding
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why does the following loop produce an <code>NA</code> ?</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-6_0d6de8370a48703f62718438f19b2424">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>rslt <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">4</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>input_vals <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>){</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  rslt[i] <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>input_vals[i]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>rslt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -3.3664950 -0.5316422  1.2368258         NA</code></pre>
</div>
</div>
</div>
</div>
<p>Loops are substantially similar in any programming language but usually not optimized for performance. Additionally, they are somewhat verbose and hard to read due to explicit use of indexing in the syntax.</p>
</section>
<section id="multiple-testing-with-loops" class="level3">
<h3 class="anchored" data-anchor-id="multiple-testing-with-loops">Multiple testing with loops</h3>
<p>In base R, the <span class="math inline">\(t\)</span>-test is performed using <code>t.test(...)</code> , which takes as arguments two vectors of observations (one for each group). For instance:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-7_c2eddb9c8b7c47c1fa5c644242102a08">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'ASD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(CHIP)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'TD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(CHIP)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(x, y, <span class="at">var.equal =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  x and y
t = -0.18812, df = 151.74, p-value = 0.851
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -0.2588194  0.2138173
sample estimates:
  mean of x   mean of y 
-0.04922954 -0.02672849 </code></pre>
</div>
</div>
<p>The output is a list:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-8_5c9cdef4df8fa1744ee80f31f104c4ba">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(x, y) <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ statistic  : Named num -0.188
  ..- attr(*, "names")= chr "t"
 $ parameter  : Named num 152
  ..- attr(*, "names")= chr "df"
 $ p.value    : num 0.851
 $ conf.int   : num [1:2] -0.259 0.214
  ..- attr(*, "conf.level")= num 0.95
 $ estimate   : Named num [1:2] -0.0492 -0.0267
  ..- attr(*, "names")= chr [1:2] "mean of x" "mean of y"
 $ null.value : Named num 0
  ..- attr(*, "names")= chr "difference in means"
 $ stderr     : num 0.12
 $ alternative: chr "two.sided"
 $ method     : chr "Welch Two Sample t-test"
 $ data.name  : chr "x and y"
 - attr(*, "class")= chr "htest"</code></pre>
</div>
</div>
<p>So if we want the p-value:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-9_7cabf4360925897819b20bb97d3daba8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(x, y, <span class="at">var.equal =</span> F)<span class="sc">$</span>p.value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8510352</code></pre>
</div>
</div>
<p>To calculate <span class="math inline">\(p\)</span>-values for all tests using a loop, we wrap the code we used to perform one <span class="math inline">\(t\)</span>-test in a <code>for</code> loop and add appropriate indexing. For speed, we’ll just compute the first 100 tests:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-10_75af781f263d5b2698efc2ff3ce34551">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>n_tests <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>p_vals <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_tests)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_tests){</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'ASD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'TD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  p_vals[i] <span class="ot">&lt;-</span> <span class="fu">t.test</span>(x, y, <span class="at">var.equal =</span> F)<span class="sc">$</span>p.value</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To line these up with the proteins they correspond to, it’s necessary to keep track of the indexing carefully. In this case, the indexing corresponds to the order of columns. So we could create a data frame like so:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-11_48bc417637a2faf21f2f52d3069d090b">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">protein =</span> <span class="fu">colnames</span>(asd)[<span class="dv">2</span><span class="sc">:</span>(n_tests <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">p =</span> p_vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 2
   protein        p
   &lt;chr&gt;      &lt;dbl&gt;
 1 CHIP     0.851  
 2 CEBPB    0.0322 
 3 NSE      0.350  
 4 PIAS4    0.104  
 5 IL-10 Ra 0.0232 
 6 STAT3    0.00183
 7 IRF1     0.592  
 8 c-Jun    0.0351 
 9 Mcl-1    0.999  
10 OAS1     0.942  
# … with 90 more rows</code></pre>
</div>
</div>
<p>Alternatively, we could have set up the loop to output this result:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-12_8fa247363e9085a2a917ef5ec084cd90">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>n_tests <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>rslt <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">protein =</span> <span class="fu">colnames</span>(asd)[<span class="dv">2</span><span class="sc">:</span>(n_tests <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">p =</span> <span class="cn">NA</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_tests){</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'ASD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'TD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  rslt<span class="sc">$</span>p[i] <span class="ot">&lt;-</span> <span class="fu">t.test</span>(x, y, <span class="at">var.equal =</span> F)<span class="sc">$</span>p.value</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Action
</div>
</div>
<div class="callout-body-container callout-body">
<p>Follow the example above to write a loop that stores both the <span class="math inline">\(p\)</span>-values <strong>and</strong> the estimated differences for the first 50 proteins.</p>
</div>
</div>
</section>
</section>
<section id="apply-family" class="level2">
<h2 class="anchored" data-anchor-id="apply-family">Apply family</h2>
<section id="simple-examples-1" class="level3">
<h3 class="anchored" data-anchor-id="simple-examples-1">Simple examples</h3>
<p>In R, the apply family of functions allows one to efficiently iterate a function over an index set. So, to execute our simple for loop using <code>apply</code> , we could do something like this:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-13_7ae02a29a13023546d4f8f871e9a4686">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">4</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>simple_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="dv">2</span><span class="sc">*</span>x}</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(vals, simple_fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 1.062206

[[2]]
[1] 1.619845

[[3]]
[1] 5.018638

[[4]]
[1] 0.800267</code></pre>
</div>
</div>
<p>This applies <code>simple_fn</code> to each element of <code>vals</code> , and returns the result as a list. If we want a neater output format, we could use <code>sapply</code> , which is short for <em>sort-apply:</em></p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-14_182199c44a8e4b9a6e1d415146752412">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(vals, simple_fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.062206 1.619845 5.018638 0.800267</code></pre>
</div>
</div>
<p>In more complex settings it often makes sense to apply a function across an index set. This is very similar conceptually to a for loop, but faster and easier to read.</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-15_378d5716659a4a9287204f2824142a78">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply a function to an index set</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>simple_fn_ix <span class="ot">&lt;-</span> <span class="cf">function</span>(i){<span class="dv">2</span><span class="sc">*</span>vals[i]}</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>rslt_apply <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vals), simple_fn_ix)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># equivalent for loop</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>rslt_loop <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(vals))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vals)){</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  rslt_loop[i] <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>vals[i]</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># compare</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(rslt_loop, rslt_apply)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               [,1]     [,2]     [,3]     [,4]
rslt_loop  1.062206 1.619845 5.018638 0.800267
rslt_apply 1.062206 1.619845 5.018638 0.800267</code></pre>
</div>
</div>
</section>
<section id="t-tests-using-apply" class="level3">
<h3 class="anchored" data-anchor-id="t-tests-using-apply"><span class="math inline">\(t\)</span>-tests using apply</h3>
<p>We can use <code>apply</code> functions to compute <span class="math inline">\(t\)</span>-tests for the proteins in the ASD data by coercing the data to a list of data frames that contain the grouping and level for each protein.</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-16_0a5d3a63da03aab7d03bee0b3f76f4bd">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of tests to perform</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>n_tests <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to a list</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>asd_list <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span>(n_tests <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>group,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">'protein'</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">'level'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(protein) <span class="sc">%&gt;%</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_split</span>()</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># first entry in list</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>asd_list[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 154 × 3
   group protein                     level
   &lt;chr&gt; &lt;chr&gt;                       &lt;dbl&gt;
 1 ASD   14-3-3 protein beta/alpha -0.124 
 2 ASD   14-3-3 protein beta/alpha  0.487 
 3 ASD   14-3-3 protein beta/alpha -0.801 
 4 ASD   14-3-3 protein beta/alpha  2.73  
 5 ASD   14-3-3 protein beta/alpha  1.24  
 6 ASD   14-3-3 protein beta/alpha  0.250 
 7 ASD   14-3-3 protein beta/alpha  0.932 
 8 ASD   14-3-3 protein beta/alpha  0.0873
 9 ASD   14-3-3 protein beta/alpha  0.213 
10 ASD   14-3-3 protein beta/alpha  0.157 
# … with 144 more rows</code></pre>
</div>
</div>
<p>The function <code>t.test(...)</code> can also perform the test using a <em>formula</em> of the form <code>y ~ x</code> and a data frame containing <code>x</code> and <code>y</code>, as below.</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-17_901be4ec226c961429f5306488840e23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(level <span class="sc">~</span> group, <span class="at">data =</span> asd_list[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  level by group
t = -1.5671, df = 150.2, p-value = 0.1192
alternative hypothesis: true difference in means between group ASD and group TD is not equal to 0
95 percent confidence interval:
 -0.54341111  0.06269287
sample estimates:
mean in group ASD  mean in group TD 
       -0.1341683         0.1061909 </code></pre>
</div>
</div>
<p>If we just want the <span class="math inline">\(p\)</span>-value again, we can wrap this code in a function whose argument is the index <span class="math inline">\(i\)</span>. This function will return the <span class="math inline">\(p\)</span>-value for the <span class="math inline">\(i\)</span>th protein.</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-18_4b3e6baace76f64750cf66611d4ff85b">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># p value for ith protein</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>tt_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(i){</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t.test</span>(level <span class="sc">~</span> group, <span class="at">data =</span> asd_list[[i]])<span class="sc">$</span>p.value</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tt_fn</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1191888</code></pre>
</div>
</div>
<p>Now to perform many tests, we can simply iterate this function over consecutive index values <code>1:n_tests</code>:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-19_7d192b0231bf59115e3022d96af9d349">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>n_tests, tt_fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] 1.191888e-01 2.972829e-01 8.297144e-01 3.034583e-02 8.136635e-01
  [6] 9.517828e-01 3.553359e-01 2.671529e-03 6.458878e-01 3.915314e-04
 [11] 1.759142e-01 3.505666e-02 5.095419e-01 4.788545e-07 2.862286e-01
 [16] 5.714296e-01 7.052780e-03 3.220583e-02 8.510352e-01 1.267133e-03
 [21] 9.482110e-03 1.293157e-04 7.804081e-03 2.208460e-04 1.407044e-01
 [26] 1.023033e-01 8.995855e-02 1.578665e-02 3.113212e-04 2.920587e-02
 [31] 4.663516e-07 2.395764e-01 5.709433e-03 8.962287e-02 2.700053e-02
 [36] 5.357313e-01 7.392658e-01 8.665332e-01 3.538260e-02 1.956257e-04
 [41] 8.658766e-01 2.111378e-04 3.286108e-01 5.374305e-01 1.108687e-01
 [46] 1.711403e-01 4.808293e-01 6.775472e-01 3.556564e-03 2.322968e-02
 [51] 3.746226e-01 7.804488e-01 3.175372e-01 4.085249e-01 4.746117e-03
 [56] 5.917788e-01 3.748021e-02 6.433125e-01 1.121721e-03 3.234610e-03
 [61] 4.154758e-03 1.669733e-03 1.726578e-03 9.990017e-01 7.100178e-04
 [66] 4.811425e-01 8.978465e-01 3.503310e-01 9.423978e-01 3.925728e-01
 [71] 3.025965e-01 4.511875e-02 4.219360e-01 2.117196e-01 1.036412e-01
 [76] 5.590746e-01 8.148983e-01 1.399029e-02 5.096269e-04 9.145121e-02
 [81] 3.331394e-02 4.350959e-01 8.721647e-01 3.266951e-03 2.704495e-01
 [86] 4.929196e-01 1.010954e-03 3.144033e-01 7.933758e-04 1.929813e-03
 [91] 6.104791e-02 1.832399e-03 1.333513e-02 6.412884e-01 2.605232e-02
 [96] 4.130732e-01 2.579393e-01 4.096623e-01 2.925137e-01 5.866341e-01</code></pre>
</div>
</div>
<p>You might have noticed this was much faster than the loop. We can time it:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-20_70ba8309d9061b7ef1d5270806f6335e">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>rslt <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>n_tests, tt_fn)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>end <span class="sc">-</span> start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 0.209661 secs</code></pre>
</div>
</div>
<p>And compare with the for loop:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-21_2a249d1503b22ed0523d07587cffcdf0">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>n_tests <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>rslt <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">protein =</span> <span class="fu">colnames</span>(asd)[<span class="dv">2</span><span class="sc">:</span>(n_tests <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">p =</span> <span class="cn">NA</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_tests){</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'ASD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'TD'</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  rslt<span class="sc">$</span>p[i] <span class="ot">&lt;-</span> <span class="fu">t.test</span>(x, y, <span class="at">var.equal =</span> F)<span class="sc">$</span>p.value</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>end <span class="sc">-</span> start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 11.63856 secs</code></pre>
</div>
</div>
<p>Another nice feature of <code>sapply</code> is its ability to sort and arrange multiple outputs. For example, if the function is adjusted to return both the <span class="math inline">\(p\)</span>-value and the test statistic:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-22_16f8e8e515ba188f86d3d6b148167ffa">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>tt_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(i){</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  test_rslt <span class="ot">&lt;-</span> <span class="fu">t.test</span>(level <span class="sc">~</span> group, <span class="at">data =</span> asd_list[[i]])</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">pval =</span> test_rslt<span class="sc">$</span>p.value, </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">tstat =</span> test_rslt<span class="sc">$</span>statistic)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tt_fn</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      pval    tstat.t 
 0.1191888 -1.5671297 </code></pre>
</div>
</div>
<p>Then <code>sapply</code> will return a matrix:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-23_08842cfe1f2bcf541de39d2b0ba9cc15">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, tt_fn) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
    pval tstat.t
   &lt;dbl&gt;   &lt;dbl&gt;
1 0.119   -1.57 
2 0.297   -1.05 
3 0.830   -0.215
4 0.0303  -2.19 
5 0.814    0.236</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Action
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Use <code>sapply</code> to obtain the estimated differences and standard errors for the groupwise comparisons for the first 50 proteins.</li>
<li>Arrange the result in a data frame with a column indicating the protein, a column indicating the estimated group difference, and a column indicating the standard error.</li>
</ol>
</div>
</div>
</section>
</section>
<section id="tidyverse" class="level2">
<h2 class="anchored" data-anchor-id="tidyverse">Tidyverse</h2>
<p>A final strategy for iteration comes from functional programming tools in <code>tidyverse</code> . The basic idea is:</p>
<ul>
<li><p>define a grouping structure using relevant variables (in this case, proteins)</p></li>
<li><p>collapse the data into separate data frames by group</p></li>
<li><p>apply a function to each data frame that produces test output given input data</p></li>
</ul>
<section id="nesting" class="level3">
<h3 class="anchored" data-anchor-id="nesting">Nesting</h3>
<p>One thing that tibbles can do that data frames cannot is store <em>list-columns:</em> columns that are lists of arbitrary objects. This allows for the arrangement of a much more general collection of objects in tabular form.</p>
<p>An intuitive example is <em>nested</em> data: a list-column of data frames having the same columns. If we nest the ASD data by protein, we obtain a data frame that looks like this:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-24_6972f8505a4cc7cf23b00819e1cbf78b">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>asd_nested <span class="ot">&lt;-</span> asd <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>group, </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">'protein'</span>, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">'level'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">c</span>(level, group))</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>asd_nested <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  protein  data              
  &lt;chr&gt;    &lt;list&gt;            
1 CHIP     &lt;tibble [154 × 2]&gt;
2 CEBPB    &lt;tibble [154 × 2]&gt;
3 NSE      &lt;tibble [154 × 2]&gt;
4 PIAS4    &lt;tibble [154 × 2]&gt;
5 IL-10 Ra &lt;tibble [154 × 2]&gt;</code></pre>
</div>
</div>
<p>The <code>data</code> column consists of data frames, one per protein, containing the variables <code>group</code> and <code>level</code> :</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-25_7186e48cec18420f95b6a1759a4d3d49">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>asd_nested <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(1L) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 154 × 2
     level group
     &lt;dbl&gt; &lt;chr&gt;
 1  0.335  ASD  
 2 -0.0715 ASD  
 3 -0.406  ASD  
 4 -0.102  ASD  
 5 -0.395  ASD  
 6 -0.126  ASD  
 7  0.486  ASD  
 8 -0.990  ASD  
 9 -0.108  ASD  
10  0.485  ASD  
# … with 144 more rows</code></pre>
</div>
</div>
</section>
<section id="the-map-function" class="level3">
<h3 class="anchored" data-anchor-id="the-map-function">The <code>map()</code> function</h3>
<p>In an ordinary data frame one can define a new variable as a function of other variables. The same can be done with list-columns in a tibble: one can define a new variable as a function of the elements of a list stored in another column. To do this, one uses the <code>map()</code> function, which is essentially the tidyverse version of <code>lapply()</code> :</p>
<ul>
<li><code>map(.x, .fn)</code> means roughly “apply the function <code>.fn</code> to each element in <code>.x</code>”</li>
</ul>
<p>Here we can write a function that takes a data frame with protein level and group as input, and returns a t test as output; then computing each test is as simple as calling <code>mutate</code> :</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-26_1790acc831ee27f1ae89c9053d20a1d0">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>tt_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(.df){</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t.test</span>(level <span class="sc">~</span> group, <span class="at">data =</span> .df)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>rslt <span class="ot">&lt;-</span> asd_nested <span class="sc">%&gt;%</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ttest.out =</span> <span class="fu">map</span>(data, tt_fn))</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>rslt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   protein  data               ttest.out
   &lt;chr&gt;    &lt;list&gt;             &lt;list&gt;   
 1 CHIP     &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 2 CEBPB    &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 3 NSE      &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 4 PIAS4    &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 5 IL-10 Ra &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 6 STAT3    &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 7 IRF1     &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 8 c-Jun    &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
 9 Mcl-1    &lt;tibble [154 × 2]&gt; &lt;htest&gt;  
10 OAS1     &lt;tibble [154 × 2]&gt; &lt;htest&gt;  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>rslt <span class="sc">%&gt;%</span> <span class="fu">slice</span>(1L) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ttest.out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

    Welch Two Sample t-test

data:  level by group
t = -0.18812, df = 151.74, p-value = 0.851
alternative hypothesis: true difference in means between group ASD and group TD is not equal to 0
95 percent confidence interval:
 -0.2588194  0.2138173
sample estimates:
mean in group ASD  mean in group TD 
      -0.04922954       -0.02672849 </code></pre>
</div>
</div>
<p>While all the data we might want are there, the output is a little unwieldy. Luckily, the <code>infer</code> package contains a pipe-operator-friendly function <code>infer::t_test</code> that returns results in a tidy fashion.</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-27_6e388a53327918b95f9820f7ac38a0aa">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>asd_nested <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(1L) <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> data) <span class="sc">%&gt;%</span> </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  infer<span class="sc">::</span><span class="fu">t_test</span>(<span class="at">formula =</span> level <span class="sc">~</span> group,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">order =</span> <span class="fu">c</span>(<span class="st">'ASD'</span>, <span class="st">'TD'</span>),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">alternative =</span> <span class="st">'two-sided'</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">var.equal =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  statistic  t_df p_value alternative estimate lower_ci upper_ci
      &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1    -0.188  152.   0.851 two.sided    -0.0225   -0.259    0.214</code></pre>
</div>
</div>
<p>We can create a wrapper around this function suitable for our purposes and then apply it to the list-column in <code>asd_nested</code> :</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-28_1efdc942f90e7e47ac1d48650864975c">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># wrapper around infer::t_test</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>tt_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(.df){</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  infer<span class="sc">::</span><span class="fu">t_test</span>(.df, </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">formula =</span> level <span class="sc">~</span> group,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">order =</span> <span class="fu">c</span>(<span class="st">'ASD'</span>, <span class="st">'TD'</span>),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">alternative =</span> <span class="st">'two-sided'</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">var.equal =</span> F)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># compute test results</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>tt_out <span class="ot">&lt;-</span> asd_nested <span class="sc">%&gt;%</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>n_tests) <span class="sc">%&gt;%</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ttest =</span> <span class="fu">map</span>(data, tt_fn))</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co"># preview</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>tt_out <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  protein data               ttest           
  &lt;chr&gt;   &lt;list&gt;             &lt;list&gt;          
1 CHIP    &lt;tibble [154 × 2]&gt; &lt;tibble [1 × 7]&gt;
2 CEBPB   &lt;tibble [154 × 2]&gt; &lt;tibble [1 × 7]&gt;
3 NSE     &lt;tibble [154 × 2]&gt; &lt;tibble [1 × 7]&gt;
4 PIAS4   &lt;tibble [154 × 2]&gt; &lt;tibble [1 × 7]&gt;</code></pre>
</div>
</div>
<p>Notice that <code>ttest</code> is also a list-column comprised of separate data frames. This column can be un-nested to show the output of <code>infer::t_test</code> explicitly:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-29_9f1d82ef2e92396665bf041809bcbb3d">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>tt_out <span class="sc">%&gt;%</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(ttest) <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 9
  protein data     statistic  t_df p_value alternative estimate lower_ci
  &lt;chr&gt;   &lt;list&gt;       &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;    &lt;dbl&gt;
1 CHIP    &lt;tibble&gt;    -0.188  152.  0.851  two.sided    -0.0225  -0.259 
2 CEBPB   &lt;tibble&gt;     2.16   150.  0.0322 two.sided     0.317    0.0273
3 NSE     &lt;tibble&gt;     0.937  151.  0.350  two.sided     0.148   -0.164 
4 PIAS4   &lt;tibble&gt;     1.64   152.  0.104  two.sided     0.222   -0.0459
# … with 1 more variable: upper_ci &lt;dbl&gt;</code></pre>
</div>
</div>
<p>This approach has a few advantages, namely, it is syntactically more readable than either of the other approaches and it works with the pipe operator, so could in theory be incorporated into a chain that performs additional calculations on, say, the results of the <span class="math inline">\(t\)</span>-test. However, the drawback is that it is slow:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-30_f73d6fe9bae4ed4a6ed23282cc9ddd48">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># time it</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>tt_out <span class="ot">&lt;-</span> asd_nested <span class="sc">%&gt;%</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>n_tests) <span class="sc">%&gt;%</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ttest =</span> <span class="fu">map</span>(data, tt_fn))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>end <span class="sc">-</span> start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 4.896297 secs</code></pre>
</div>
</div>
<p>It’s not as slow as a for loop, but it’s much slower than <code>apply</code> functions. If speed is a concern or the number of iterations is especially large, <code>apply</code> would be a better choice.</p>
</section>
<section id="adjusting-p-values" class="level3">
<h3 class="anchored" data-anchor-id="adjusting-p-values">Adjusting p-values</h3>
<p>To adjust the <span class="math inline">\(p\)</span>-values, we simply manipulate the <code>p_value</code> column:</p>
<div class="cell" data-hash="lab3-iteration_cache/html/unnamed-chunk-31_1c7cbb9546c6bff0bcc7b162cd75a365">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># bonferroni correction</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>tt_out <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(ttest) <span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_adj =</span> p_value<span class="sc">*</span>n_tests) <span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(protein, p_value, p_adj) <span class="sc">%&gt;%</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(p_adj) <span class="sc">%&gt;%</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  protein     p_value     p_adj
  &lt;chr&gt;         &lt;dbl&gt;     &lt;dbl&gt;
1 FSTL1   0.000000466 0.0000466
2 C1QR1   0.000000479 0.0000479
3 DSC2    0.000129    0.0129   
4 HIF-1a  0.000196    0.0196   </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Action
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Implement the Benjamini-Hochberg correction</strong></p>
<ol type="1">
<li>Sort the raw <span class="math inline">\(p\)</span>-values using <code>arrange()</code></li>
<li>Add a <code>rank</code> column of consecutive integers (neat trick: try using <code>row_number()</code>)</li>
<li>Add a column <code>p_adj</code> containing <span class="math inline">\(\frac{m}{i} p_{(i)}\)</span> where <span class="math inline">\(m\)</span> is the number of tests, <span class="math inline">\(i\)</span> is the rank of the <span class="math inline">\(p\)</span>-value, and <span class="math inline">\(p_{(i)}\)</span> is the <span class="math inline">\(i\)</span>th smallest <span class="math inline">\(p\)</span>-value</li>
<li>Find the collection of proteins with significantly different serum levels between the ASD and TD groups while controlling the false discovery rate at 1%.</li>
</ol>
<p>Develop working code to execute 50 tests. Then use it to compute all 1317 tests.</p>
</div>
</div>
</section>
</section>
<section id="checklist" class="level2">
<h2 class="anchored" data-anchor-id="checklist">Checklist</h2>
<ul>
<li><p>You’ve computed <span class="math inline">\(p\)</span>-values iteratively using a loop, <code>sapply</code> , and <code>nest</code>+<code>map</code> .</p></li>
<li><p>You have commented codes in your script for each action item.</p></li>
<li><p>You’ve obtained a list of the significant proteins with 1% FDR.</p></li>
<li><p>You’ve saved your work somewhere where you can access it later.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Copyright 2023 Trevor Ruiz</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>